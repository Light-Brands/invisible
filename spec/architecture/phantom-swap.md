# Phantom Swap — Atomic Cross-Chain Swaps

## Overview
Phantom Swap enables trustless cross-chain cryptocurrency swaps without centralized exchanges, KYC, or intermediaries. Every phase of a swap -- orderbook discovery, negotiation, HTLC creation, on-chain broadcast, monitoring, and settlement -- passes through the full 7-layer Scrambler pipeline. Counterparties never learn each other's identity, IP, location, or timing patterns. An observer cannot distinguish a user who is actively swapping from one who simply has their wallet open.

## How It Works
1. User wants to swap (e.g., 0.1 BTC for XMR)
2. Phantom Swap finds a counterparty via P2P orderbook (through Scrambler)
3. Hash Time-Locked Contract (HTLC) negotiated through full Scrambler pipeline
4. HTLC created — both parties lock funds via temporally scrambled on-chain broadcasts
5. Swap executes — both parties receive their funds
6. No exchange, no KYC, no account, no trace

## Supported Swap Pairs
- BTC <-> XMR (atomic swap, no intermediary)
- ETH <-> XMR (via atomic swap bridge)
- BTC <-> ZEC (atomic swap)
- Any <-> Any (multi-hop: A -> XMR -> B for max privacy)

## The XMR Hop
For maximum unlinkability, route any swap through Monero as intermediary:
BTC -> XMR (atomic swap) -> hold -> XMR -> ETH (atomic swap)
This breaks any chain analysis between source and destination chains.

The hold period between swap legs includes a mandatory protocol-enforced minimum random delay (not merely user-configurable). This delay is drawn from a Poisson distribution with a minimum floor, ensuring that even a user who sets "minimum delay" cannot create a timing correlation between the two legs. The protocol enforces this at the HTLC timeout calculation layer -- the second leg's HTLC is not constructed until the mandatory delay has elapsed.

---

## Swap Privacy Pipeline

Every phase of a Phantom Swap receives the full 7-layer Scrambler treatment: fragmented via Shamir's Secret Sharing, routed through the mixnet with batching and shuffling, padded with cover traffic, jurisdiction-scrambled across non-cooperating countries, camouflaged by pluggable transports, mediated through dead drops, and temporally scrambled with random delays. The following details how each swap phase maps to this pipeline.

### Orderbook Discovery

Order announcements are Sphinx packets routed through the full mixnet. They are indistinguishable from messaging cover traffic -- same 2048-byte fixed-size packets, same constant-rate transmission, same Poisson-distributed delays at each mix node.

- **Cover orders.** Dummy orders are mixed into the orderbook gossip stream as cover traffic. These dummy orders have valid structure (pair, amount, rate, expiry) but are generated by the protocol and silently discarded by recipients. An observer monitoring the orderbook gossip layer cannot distinguish "this user is looking for a swap" from the constant stream of cover traffic and dummy orders.
- **No activity signal.** Because cover traffic runs continuously (Layer 3), the act of publishing a real order does not cause any observable change in a user's traffic pattern. The real order replaces one cover packet in the constant-rate stream.

### Swap Negotiation

All HTLC negotiation messages between Alice and Bob traverse the complete 7-layer Scrambler:

1. **Fragmented** (Layer 1): Each negotiation message is split into Shamir shares (3-of-5 default), each routed through an independent mixnet path.
2. **Mixed** (Layer 2): Each share passes through 5 layers of mix nodes with batching, shuffling, and Poisson delays.
3. **Cover-padded** (Layer 3): Negotiation messages replace cover packets in the constant-rate stream. No traffic burst signals "negotiation in progress."
4. **Jurisdiction-routed** (Layer 4): Each share's path spans 5+ countries across non-cooperating jurisdictions. No single government can compel the full path.
5. **Camouflaged** (Layer 5): Wire protocol is obfs5, TLS-camouflaged, or CDN-fronted. DPI cannot identify swap negotiation traffic.
6. **Dead-dropped** (Layer 6): Alice deposits shares at anonymous dead drops. Bob retrieves from different dead drops via different mixnet paths. The dead drop relays cannot correlate depositor and retriever.
7. **Temporally scrambled** (Layer 7): Random pre-delays, per-node Poisson delays, and polling jitter destroy any temporal correlation between Alice's send time and Bob's receive time.

**Result**: Neither Alice nor Bob can determine the other's IP address, geographic location, timezone, or timing patterns. A global passive adversary observing the entire network cannot determine that Alice and Bob are negotiating a swap.

### HTLC Creation and Claim

On-chain HTLC transactions -- locking funds, claiming with preimage, and refunding on timeout -- are broadcast through multi-node Scrambler exit paths with temporal scrambling.

- **Multi-node broadcast.** Each on-chain transaction (BTC lock, XMR lock, claim, refund) is broadcast to multiple blockchain nodes simultaneously via separate Scrambler exit paths. This prevents first-seen geolocation -- a chain analysis firm monitoring mempool propagation cannot determine the geographic origin of the transaction.
- **Temporal scrambling.** A random delay (Poisson-distributed, configurable mean, protocol-enforced minimum) is inserted between "swap agreed" and "HTLC appears on chain." The HTLC timeout windows are calculated to accommodate this delay while maintaining atomicity guarantees. An observer sees the HTLC appear on-chain at a random time that cannot be correlated to the negotiation completion time.
- **Fee estimation proxied.** Fee estimation queries for both chains are routed through the Scrambler. The user's client never directly queries a blockchain node for fee data -- all fee estimation traffic passes through the full mixnet with cover queries as camouflage. This prevents a blockchain node operator from correlating "fee query at time T" with "HTLC broadcast at time T+delta" to link fee estimation to transaction origin.

### HTLC Monitoring

Monitoring the counterparty's HTLC (checking whether they have claimed, checking for refund conditions) goes through the Scrambler with dummy monitoring queries as cover.

- **Scrambled monitoring queries.** All HTLC status checks are Sphinx packets routed through the full mixnet. The client does not connect directly to blockchain nodes to check HTLC status.
- **Dummy monitoring.** The client continuously generates dummy HTLC monitoring queries at a constant rate, indistinguishable from real monitoring queries. When the client is genuinely monitoring an active HTLC, the real queries replace dummy queries in the constant-rate stream. An observer cannot distinguish "user has active swap" from "wallet is open."
- **Multi-source monitoring.** HTLC status is queried from multiple independent blockchain nodes via separate Scrambler exit paths. This prevents a single compromised node from learning which HTLCs a user is monitoring.

---

## Swap Cover Traffic

The Phantom Swap module maintains its own cover traffic layer, integrated with and indistinguishable from the Scrambler's global cover traffic (Layer 3).

### Constant-Rate Swap-Shaped Traffic

- **Dummy swap operations.** The client generates constant-rate dummy traffic that mimics the full lifecycle of a swap: dummy order announcements, dummy negotiation messages, dummy HTLC monitoring queries, dummy fee estimation requests. All are valid Sphinx packets, identical in size and timing to real swap traffic.
- **Indistinguishable from real swaps.** Each dummy message has the same structure, size (2048-byte Sphinx packets), and timing characteristics as a real swap message. They traverse the full mixnet and are silently discarded at exit.
- **No activity transition signal.** Because dummy swap traffic flows continuously, the transition from "idle wallet" to "active swap" produces zero observable change in the user's traffic pattern.

### Monitoring Cover

- **Constant monitoring queries.** The client sends HTLC monitoring queries at a constant rate regardless of whether any real swaps are in progress. When a real swap is active, real monitoring queries replace dummy ones in the stream.
- **Dummy fee queries.** Fee estimation queries for all supported chains are generated at a constant rate as cover traffic, regardless of whether the user intends to swap on those chains.
- **Orderbook polling cover.** Dead drop polling for orderbook updates happens at a constant rate with jitter, identical to messaging dead drop polling. No observable difference between "checking for swap matches" and "checking for messages."

---

## Cross-Chain Timing Decorrelation

Atomic swaps inherently involve correlated on-chain events: when Alice locks BTC, Bob must eventually lock XMR. Chain analysis firms attempt to exploit this temporal correlation -- "BTC locked at time T, XMR locked at time T+delta, therefore these two transactions are the two legs of an atomic swap." The Scrambler defeats this through deliberate timing decorrelation.

### Two-Leg Desynchronization

The two on-chain transactions in a standard atomic swap (e.g., Alice's BTC lock and Bob's XMR lock) are deliberately desynchronized:

- **Independent random delays.** Each leg's on-chain broadcast includes an independent random delay (Poisson-distributed) between "party decides to lock" and "lock transaction appears on-chain." These delays are independent -- they share no common timing reference.
- **HTLC timeout accommodation.** The HTLC timeout windows are calculated to accommodate maximum expected delay from temporal scrambling while preserving atomicity. The protocol adds a temporal scrambling buffer to all timeout calculations.
- **Timing gap randomization.** The observable gap between "BTC locked on-chain" and "XMR locked on-chain" is randomized. Even though the HTLC protocol creates a causal relationship (Bob locks after seeing Alice's lock), the on-chain timing gap is dominated by independent random delays, not the actual negotiation latency.

### XMR Hop Timing (Three-Leg Decorrelation)

For XMR Hop swaps (A -> XMR -> B), three on-chain transactions occur. Each receives independent timing decorrelation:

1. **Source chain lock** (e.g., BTC): Broadcast with independent random delay via multi-node Scrambler exit paths.
2. **XMR intermediate**: The XMR leg includes the mandatory protocol-enforced hold period (minimum random delay plus user-configurable additional hold). This is the largest timing gap and provides the strongest decorrelation.
3. **Destination chain claim** (e.g., ETH): Broadcast with independent random delay via separate Scrambler exit paths.

```
    STANDARD ATOMIC SWAP (without Scrambler):

    BTC chain:   ---[LOCK]---------------------------[CLAIM by Bob]---
    XMR chain:   ----------[LOCK]---[CLAIM by Alice]-----------------
    Timing:      T          T+2min  T+3min           T+5min
                 ^                                   ^
                 Chain analysis: "These are clearly correlated"

    ================================================================

    PHANTOM SWAP (with full Scrambler pipeline):

    BTC chain:   ------[LOCK]---------------------------------[CLAIM]-------
    XMR chain:   -----------------[LOCK]------[CLAIM]----------------------
    Timing:      T     T+Δ1       T+Δ1+Δ2    T+Δ1+Δ2+Δ3     T+Δ1+Δ4
                       (random)   (random)    (random)        (random)
                 ^                                                    ^
                 All Δ values are independent Poisson-distributed delays.
                 Observable timing gaps reveal no correlation signal.

    ================================================================

    XMR HOP (A → XMR → B, with Scrambler):

    Source (BTC):   ---[LOCK]----------------------------------------[refund window]---
    XMR:            --------------------[LOCK]----[CLAIM]--[HOLD..........]-----------
    Dest (ETH):     ---------------------------------------------------[LOCK]--[CLAIM]
    Timing:         T  T+Δ1             T+Δ1+Δ2  T+Δ3     T+Δ3+HOLD+Δ4  T+Δ5   T+Δ6
                                                           ^
                                                           Mandatory hold period
                                                           (protocol-enforced minimum
                                                           random delay) breaks any
                                                           timing link between source
                                                           and destination chains.
```

### Fee Timing Decorrelation

Fee estimation queries are decorrelated from transaction broadcasts:

- Fee data for both chains is fetched continuously through the Scrambler as part of cover traffic (see Swap Cover Traffic above).
- The fee data used for a transaction may have been fetched minutes or hours before the actual broadcast, further breaking any "fee query -> transaction" timing correlation.
- Fee queries are never sent in a burst correlated with swap activity. They maintain a constant rate.

---

## HTLC Protocol
### Step-by-step:
1. **Alice** wants to sell BTC for XMR. **Bob** wants to sell XMR for BTC.
2. Alice generates a secret `s` and computes `h = SHA256(s)`.
3. Alice locks BTC in an HTLC: "Bob can claim with preimage of h, OR Alice can refund after 24 hours."
4. Bob sees Alice's HTLC, locks XMR in corresponding HTLC: "Alice can claim with preimage of h, OR Bob can refund after 12 hours."
5. Alice claims Bob's XMR by revealing `s` on the Monero chain.
6. Bob uses `s` (now public) to claim Alice's BTC.
7. Swap complete. Atomic: if Alice doesn't reveal `s`, both refund.

All steps above that involve network communication (steps 2-6 negotiation messages, HTLC broadcast, preimage revelation monitoring) pass through the full Scrambler pipeline as described in the Swap Privacy Pipeline section.

---

## P2P Orderbook
- Decentralized orderbook distributed through the Scrambler
- Orders are anonymous: identity of maker/taker is never revealed
- Order matching is done client-side
- No central server coordinates swaps
- Orders include: pair, amount, rate, expiry
- Stale orders auto-expire
- **Uniform packet size.** All orders are padded to exactly 2048 bytes -- the same size as all Sphinx packets in the Scrambler. There is no size-based information leak. A large order and a small order produce identical packets. An order announcement is indistinguishable from a messaging packet, a cover traffic packet, or any other Sphinx packet on the wire.
- **Order cancellations through Scrambler.** Cancellations are full Sphinx packets routed through the complete 7-layer pipeline. An observer cannot distinguish "user cancelled an order" from cover traffic. Cancellations are padded to the same 2048-byte uniform size.
- **Gossip protocol matches messaging cover.** The orderbook gossip protocol uses the same constant-rate cover traffic pattern as the messaging system (Layer 3). Orderbook gossip packets are transmitted at a constant rate with Poisson jitter. Dummy orders fill the stream when no real orders are being published. The gossip traffic pattern is indistinguishable from messaging cover traffic.

---

## Swap Privacy
- All negotiation messages encrypted and routed through full 7-layer Scrambler pipeline
- Counterparty never learns your IP, identity, location, or timing patterns
- On-chain transactions use privacy features of respective chains
- XMR side: fully private by default
- BTC side: uses CoinJoin/PayJoin + fresh address
- No swap history on any server — local device only
- **Multi-node on-chain broadcast.** All on-chain swap transactions (HTLC lock, claim, refund) are broadcast to multiple independent blockchain nodes via separate Scrambler exit paths simultaneously. This defeats first-seen geolocation analysis -- no single blockchain node can be the sole source of propagation timing data. Each broadcast path uses a different mixnet exit gateway in a different jurisdiction.
- **Fee estimation through Scrambler.** All fee estimation queries for all supported chains are proxied through the Scrambler with the full 7-layer pipeline. The client never directly contacts a blockchain node for fee data. Fee queries are indistinguishable from cover traffic and run at a constant rate regardless of swap activity.
- **HTLC monitoring through Scrambler.** All HTLC status monitoring (checking if counterparty has locked, claimed, or if timeout has elapsed) goes through the full Scrambler pipeline. Dummy HTLC monitoring queries run continuously as cover traffic at a constant rate. Real monitoring queries replace dummy queries in the stream. An observer cannot distinguish "user is monitoring an active HTLC" from "user's wallet is idle."
- **Block header retrieval through Scrambler.** SPV proof verification and block header fetches for HTLC validation are routed through the Scrambler. The client does not reveal which blocks or transactions it is interested in.

---

## Implementation
- COMIT network HTLC library (Rust)
- XMR<->BTC atomic swap protocol (proven, audited)
- Custom HTLC contracts for ETH/ERC-20 pairs
- Timeout handling: automatic refund on expiry, with temporal scrambling buffer added to all timeout calculations
- Fee estimation: real-time chain fee data (fetched through Scrambler at constant rate as cover traffic)
- Multi-node broadcast: transaction relay via multiple Scrambler exit paths (Rust, async via `tokio`)
- Cover traffic generation: swap-shaped dummy traffic scheduler integrated with Scrambler Layer 3

Cross-references: [shadow-wallet.md](shadow-wallet.md), [scrambler.md](scrambler.md), [defi-proxy.md](defi-proxy.md)
